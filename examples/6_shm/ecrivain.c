/* Processus ecrivain */
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/sem.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define CLEF 666

#define LONGUEUR_SEGMENT 512 


int main(int argc,char *argv[])
{
  int semaphores;
  int memoirePartagee;
  struct sembuf manipSemaphores[2];
  char *attacheMoi;

  

  if ((memoirePartagee=shmget(CLEF,LONGUEUR_SEGMENT,IPC_CREAT|0666)) == -1)
  {
    puts("Impossible de creer le segment de memoire partagee");
    exit(1);
  }


  if ((semaphores=semget(CLEF,2,IPC_CREAT|0666)) == -1)
  {
    puts("Impossible de creer les semaphores");
    exit(1);
  }

  /* Les deux operations d'initialisation des semaphores sont faites
     en meme temps */

  manipSemaphores[0].sem_num=0; 
  manipSemaphores[0].sem_op=1;

  manipSemaphores[1].sem_num=1;
  manipSemaphores[1].sem_op=1;

  semop(semaphores,manipSemaphores,2);

  /* Operation P(1) sur le premier semaphore => prise de ressource sur la 
     memoire partagee */

  manipSemaphores[0].sem_num=0;
  manipSemaphores[0].sem_op=-1;

  semop(semaphores,manipSemaphores,1);

  puts("Je prends la ressource");fflush(stdout);

  attacheMoi=shmat(memoirePartagee,NULL,0);


  //if ((int)(attacheMoi)==-1)
  if (attacheMoi==(void*)-1)
  {
    puts("Impossible d'attacher !");
    exit(1);
  }
  else
  {
    printf("Adresse de l'attachement : %p \n",attacheMoi);
    strcpy(attacheMoi,"Message a l'adresse de l'autre processus !");
    shmdt(attacheMoi);
    
    /* Operation V(1) sur le premier semaphore => liberation de la ressource
       memoire partagee */
    
    manipSemaphores[0].sem_num=0;
    manipSemaphores[0].sem_op=1;
    semop(semaphores,manipSemaphores,1);
  }


  puts("Attente de l'autre processus");
  fflush(stdout);

  /* Operation Z sur le second semaphore */

  manipSemaphores[0].sem_num=1;
  manipSemaphores[0].sem_op=0;
  semop(semaphores,manipSemaphores,1);
  

  puts("Debloque !");
  fflush(stdout);
 
  /* Suppression des IPC */

  semctl(semaphores,0,IPC_RMID);
  
  shmctl(memoirePartagee,IPC_RMID,0);
  
  
  return 0;

}
