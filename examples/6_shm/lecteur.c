/* Processus lecteur */

#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/sem.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define CLEF 666

#define LONGUEUR_SEGMENT 512 


int main(int argc,char *argv[])
{
  int semaphores;
  int memoirePartagee;
  struct sembuf manipSemaphores;
  char *attacheMoi;
 

  if ((memoirePartagee=shmget(CLEF,LONGUEUR_SEGMENT,0600)) == -1)
  {
    puts("Impossible d'acceder au segment de memoire partagee");
    exit(1);
  }


  if ((semaphores=semget(CLEF,2,0600)) == -1)
  {
    puts("Impossible d'acceder aux semaphores");
    exit(1);
  }
  
  /* Operation P(1) => on demande à accéder à la ressource */

  manipSemaphores.sem_num=0;
  manipSemaphores.sem_op=-1;

  semop(semaphores,&manipSemaphores,1);

  puts("Je demande a acceder a la ressource");fflush(stdout);

  attacheMoi=shmat(memoirePartagee,NULL,0);


  if (attacheMoi==(void*)-1)
  {
    puts("Impossible d'attacher !");
    exit(1);
  }
  else
  {
    printf("Adresse de l'attachement : %p \n",attacheMoi);
    puts("Contenu de la memoire a l'attachement ");
    puts(attacheMoi);
    shmdt(attacheMoi);
    manipSemaphores.sem_num=0;
    manipSemaphores.sem_op=1;
    semop(semaphores,&manipSemaphores,1);
  }
 

  puts("Deblocage de l'autre processus");
  fflush(stdout);

  /* Debloquer le semaphore en attente se fait 
     a l'aide d'une operation prise de ressource P(1) car la valeur
     courante de celui-ci est 1*/

  manipSemaphores.sem_num=1;
  manipSemaphores.sem_op=-1;
  semop(semaphores,&manipSemaphores,1);
  
  
  return 0;
}
